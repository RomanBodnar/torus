# Implementation Plan

- [x] 1. Set up project structure and core interfaces
  - Create TypeScript project with Three.js dependencies
    - Initialize npm project with `package.json`
    - Install Three.js, TypeScript, and @types/three
    - Install development dependencies: vitest, webpack/vite, ts-loader
  - Define core interfaces for TubeGeometry, Tetromino, TubeGrid, and GameEngine
    - Create `src/types/` directory for interface definitions
    - Define `TetrominoShape`, `GameState`, `InputController` interfaces
    - Create enums for `TetrominoType` and `GameStatus`
  - Set up build configuration with webpack/vite for Three.js
    - Configure TypeScript compilation settings
    - Set up development server with hot reload
    - Configure asset loading for textures and models
  - _Requirements: 1.1, 4.1_

- [ ] 2. Implement TubeGeometry and coordinate system
- [x] 2.1 Create TubeGeometry class with basic properties
  - Create `src/core/TubeGeometry.ts` file
  - Implement constructor with radius=5, height=20, segments=8 defaults
  - Add readonly properties for radius, height, segments
  - _Requirements: 1.1, 4.1_
- [ ] 2.2 Add coordinate conversion methods
  - Implement `getSegmentAngle(segment: number): number` method
  - Implement `tubeToWorld(segment: number, row: number): Vector3` method
  - Implement `worldToTube(position: Vector3): {segment: number, row: number}` method
  - _Requirements: 1.1, 4.1_
- [ ] 2.3 Write unit tests for TubeGeometry
  - Create `src/core/__tests__/TubeGeometry.test.ts`
  - Test coordinate conversion round-trip accuracy
  - Test boundary cases and wrapping behavior
  - _Requirements: 1.1, 4.1_

- [ ] 3. Create basic Three.js scene setup
- [ ] 3.1 Initialize Three.js renderer and scene
  - Create `src/core/SceneManager.ts` file
  - Initialize WebGLRenderer with antialias and alpha settings
  - Create Scene with background color and basic lighting
  - _Requirements: 1.1, 4.1_
- [ ] 3.2 Set up camera and controls
  - Create PerspectiveCamera with 75° FOV
  - Position camera to frame entire tube (15-20 units back, 15-30° above)
  - Add OrbitControls for development/debugging
  - _Requirements: 1.1, 4.1_
- [ ] 3.3 Create tube visualization
  - Create CylinderGeometry matching TubeGeometry parameters
  - Apply wireframe material for initial visualization
  - Add tube mesh to scene at origin
  - _Requirements: 1.1, 4.1_
- [ ] 3.4 Implement render loop and window handling
  - Create animation loop using requestAnimationFrame
  - Handle window resize events
  - Add basic FPS counter for performance monitoring
  - _Requirements: 1.1, 4.1_

- [ ] 4. Implement Tetromino class and shapes
- [ ] 4.1 Create tetromino shape definitions
  - Create `src/game/TetrominoShapes.ts` file
  - Define static shape data for all 7 tetromino types (I, O, T, S, Z, J, L)
  - Include block positions, colors, and rotation states for each type
  - _Requirements: 1.2, 1.4_
- [ ] 4.2 Implement Tetromino class
  - Create `src/game/Tetromino.ts` file
  - Implement constructor accepting TetrominoType
  - Add properties for position, rotation state, and shape data
  - _Requirements: 1.2, 1.4_
- [ ] 4.3 Add tetromino rotation logic
  - Implement `rotate()` method for 90-degree increments
  - Handle special cases (O-piece, I-piece)
  - Add `getBlockPositions()` method for current rotated positions
  - _Requirements: 1.2, 1.4_
- [ ] 4.4 Write unit tests for Tetromino class
  - Create `src/game/__tests__/Tetromino.test.ts`
  - Test rotation logic for all piece types
  - Test block position calculations
  - _Requirements: 1.2, 1.4_

- [ ] 5. Create TubeGrid for game state management
- [ ] 5.1 Implement TubeGrid class structure
  - Create `src/game/TubeGrid.ts` file
  - Implement constructor with segments and rows parameters
  - Create 2D array structure `grid: (Tetromino | null)[][]`
  - Add `clear()` method to reset grid state
  - _Requirements: 2.1, 2.2_
- [ ] 5.2 Add grid occupation and placement methods
  - Implement `isOccupied(segment: number, row: number): boolean`
  - Implement `canPlacePiece(tetromino: Tetromino, tubeRotation: number): boolean`
  - Implement `placePiece(tetromino: Tetromino, tubeRotation: number): void`
  - _Requirements: 2.1, 2.2_
- [ ] 5.3 Implement ring completion detection
  - Create `checkCompleteRings(): number[]` method
  - Verify all segments in a row are occupied
  - Handle multiple simultaneous ring completions
  - _Requirements: 2.1, 2.2_
- [ ] 5.4 Write unit tests for TubeGrid
  - Create `src/game/__tests__/TubeGrid.test.ts`
  - Test piece placement and collision detection
  - Test ring completion detection
  - _Requirements: 2.1, 2.2_

- [ ] 6. Implement tube rotation mechanics
- [ ] 6.1 Add rotation properties to game state
  - Update GameState interface with `tubeRotation` and `targetRotation` properties
  - Add rotation speed constant (π/4 radians per step)
  - Initialize rotation values in game state
  - _Requirements: 1.3, 1.4, 4.3_
- [ ] 6.2 Create tube rotation animation system
  - Create `src/game/TubeRotationManager.ts` file
  - Implement `rotateTube(direction: number)` method with smooth interpolation
  - Add easing functions for natural rotation feel
  - Handle rotation wrapping at 2π radians
  - _Requirements: 1.3, 1.4, 4.3_
- [ ] 6.3 Maintain tetromino orientation during rotation
  - Apply inverse rotation to tetromino meshes
  - Update tetromino world positions during tube rotation
  - Ensure consistent visual appearance
  - _Requirements: 1.3, 1.4, 4.3_
- [ ] 6.4 Write tests for rotation mechanics
  - Create `src/game/__tests__/TubeRotationManager.test.ts`
  - Test rotation wrapping and boundary handling
  - Test tetromino orientation maintenance
  - _Requirements: 1.3, 1.4, 4.3_

- [ ] 7. Add piece falling and collision detection
- [ ] 7.1 Implement gravity system
  - Add `fallTimer` and `fallSpeed` properties to GameState
  - Create `src/game/GravityManager.ts` file
  - Implement `updateFalling(deltaTime: number)` method
  - Add soft drop functionality
  - _Requirements: 2.1, 1.2_
- [ ] 7.2 Create collision detection system
  - Create `src/game/CollisionDetector.ts` file
  - Implement `checkCollision(tetromino: Tetromino, position: Vector3): boolean`
  - Check collision with tube bottom and existing pieces
  - Handle collision during tube rotation
  - _Requirements: 2.1, 1.2_
- [ ] 7.3 Add piece locking mechanism
  - Implement `lockPiece()` method in game engine
  - Add lock delay timer for player adjustment
  - Generate new piece after locking
  - Update visual representation
  - _Requirements: 2.1, 1.2_
- [ ] 7.4 Write tests for collision and falling
  - Create `src/game/__tests__/CollisionDetector.test.ts`
  - Test collision detection accuracy
  - Test lock timing and new piece generation
  - _Requirements: 2.1, 1.2_

- [ ] 8. Implement input handling system
- [ ] 8.1 Create InputController class
  - Create `src/input/InputController.ts` file
  - Set up event listeners for keydown/keyup events
  - Implement key state tracking for held vs single presses
  - _Requirements: 1.3, 1.4, 4.3_
- [ ] 8.2 Define key mappings and actions
  - Create key mapping configuration (Arrow keys, WASD, Space, P)
  - Map keys to tube rotation and piece actions
  - Implement action callbacks for game engine
  - _Requirements: 1.3, 1.4, 4.3_
- [ ] 8.3 Add input rate limiting and buffering
  - Implement debouncing for rotation commands
  - Add repeat delay for held keys
  - Create input buffer for smooth gameplay
  - _Requirements: 1.3, 1.4, 4.3_
- [ ] 8.4 Write tests for input handling
  - Create `src/input/__tests__/InputController.test.ts`
  - Test key mappings and rate limiting
  - Test input during various game states
  - _Requirements: 1.3, 1.4, 4.3_

- [ ] 9. Add line clearing and scoring system
- [ ] 9.1 Implement ring clearing logic
  - Create `src/game/RingClearManager.ts` file
  - Implement `clearRings(ringIndices: number[])` method
  - Handle removing pieces and moving remaining pieces down
  - _Requirements: 2.2, 2.3_
- [ ] 9.2 Create scoring system
  - Create `src/game/ScoreManager.ts` file
  - Implement base scoring (100 points per ring) with multipliers
  - Add level multiplier and track lines cleared
  - Update GameState with score properties
  - _Requirements: 2.2, 2.3_
- [ ] 9.3 Add visual feedback for ring clearing
  - Create flashing/highlighting effect for completed rings
  - Implement smooth falling animation after ring clear
  - Add score popup animations
  - _Requirements: 2.2, 2.3_
- [ ] 9.4 Write tests for scoring and ring clearing
  - Create `src/game/__tests__/ScoreManager.test.ts`
  - Test scoring formulas and ring clearing logic
  - Test edge cases and level progression
  - _Requirements: 2.2, 2.3_

- [ ] 10. Implement game progression and difficulty
- [ ] 10.1 Create level progression system
  - Create `src/game/LevelManager.ts` file
  - Implement level increases every 10 lines cleared
  - Reduce fall time by 10% per level with minimum cap
  - Update GameState with level properties
  - _Requirements: 3.1, 3.2, 3.3_
- [ ] 10.2 Add game over detection
  - Implement spawn position occupation check
  - Add "lock out" and "block out" game over conditions
  - Trigger game over state and stop piece generation
  - _Requirements: 3.1, 3.2, 3.3_
- [ ] 10.3 Create UI overlay for game information
  - Create `src/ui/GameUI.ts` file
  - Display score, level, lines cleared, and next piece
  - Add high score tracking with localStorage
  - _Requirements: 3.1, 3.2, 3.3_
- [ ] 10.4 Write tests for progression and game over
  - Create `src/game/__tests__/LevelManager.test.ts`
  - Test level progression and fall speed changes
  - Test game over conditions and UI updates
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 11. Add visual rendering for tetrominoes
- [ ] 11.1 Create 3D block geometry and materials
  - Create `src/rendering/BlockRenderer.ts` file
  - Create BoxGeometry with standard 1x1x1 size and slight gaps
  - Define color scheme and materials for each tetromino type
  - _Requirements: 4.2, 4.4_
- [ ] 11.2 Implement efficient block rendering
  - Use InstancedMesh for each tetromino color/type
  - Update instance matrices for block positions efficiently
  - Implement frustum culling for performance
  - _Requirements: 4.2, 4.4_
- [ ] 11.3 Add visual distinction for active vs placed pieces
  - Make active piece brighter with outline effect
  - Reduce opacity/saturation of placed pieces
  - Add subtle animation for active piece
  - _Requirements: 4.2, 4.4_
- [ ] 11.4 Write tests for rendering system
  - Create `src/rendering/__tests__/BlockRenderer.test.ts`
  - Test block creation and material assignment
  - Test instance matrix updates and performance
  - _Requirements: 4.2, 4.4_

- [ ] 12. Implement piece preview and placement feedback
- [ ] 12.1 Add ghost piece functionality
  - Create `src/rendering/GhostPiece.ts` file
  - Calculate landing position using collision detection
  - Render ghost piece with transparent/wireframe material
  - Update ghost position in real-time during tube rotation
  - _Requirements: 4.4_
- [ ] 12.2 Create next piece preview
  - Add separate small 3D scene for next piece display
  - Position next piece in UI overlay area
  - Implement slow rotation for better visibility
  - _Requirements: 4.4_
- [ ] 12.3 Implement smooth placement animations
  - Add smooth falling animation with easing
  - Create lock-in animation when piece is placed
  - Add subtle camera effects for dramatic moments
  - _Requirements: 4.4_
- [ ] 12.4 Write tests for preview systems
  - Create `src/rendering/__tests__/GhostPiece.test.ts`
  - Test ghost piece accuracy and updates
  - Test next piece preview functionality
  - _Requirements: 4.4_

- [ ] 13. Add game state management and controls
- [ ] 13.1 Implement pause/resume functionality
  - Update GameStatus enum with Paused state
  - Pause all timers and animations when paused
  - Display pause overlay with resume instructions
  - _Requirements: 3.3_
- [ ] 13.2 Add game restart capability
  - Create `resetGame()` method in game engine
  - Reset score, level, lines cleared to initial values
  - Generate new starting piece and clear tube rotation
  - _Requirements: 3.3_
- [ ] 13.3 Create game over screen
  - Display final score, level, and lines cleared
  - Show high score comparison and celebration
  - Provide restart and main menu options
  - _Requirements: 3.3_
- [ ] 13.4 Write tests for game state management
  - Create `src/game/__tests__/GameStateManager.test.ts`
  - Test pause/resume and restart functionality
  - Test game over triggers and transitions
  - _Requirements: 3.3_

- [ ] 14. Optimize performance and add error handling
- [ ] 14.1 Implement object pooling
  - Create `src/utils/TetrominoPool.ts` file
  - Pool mesh instances to avoid frequent creation/destruction
  - Implement efficient allocation and deallocation strategies
  - _Requirements: 4.3_
- [ ] 14.2 Add WebGL context loss recovery
  - Listen for webglcontextlost and webglcontextrestored events
  - Implement texture and geometry restoration
  - Display user-friendly message during restoration
  - _Requirements: 4.3_
- [ ] 14.3 Implement performance fallbacks
  - Detect low frame rates and reduce visual quality
  - Implement simplified rendering mode
  - Provide manual graphics quality settings
  - _Requirements: 4.3_
- [ ] 14.4 Add error handling and logging
  - Implement try-catch blocks around critical operations
  - Add detailed logging for debugging
  - Create user-friendly error messages
  - _Requirements: 4.3_

- [ ] 15. Create comprehensive test suite
- [ ] 15.1 Write end-to-end gameplay tests
  - Create `src/__tests__/e2e/GameplayE2E.test.ts`
  - Test complete game from start to game over
  - Test level progression and difficulty scaling
  - _Requirements: 1.1, 2.1, 3.1, 4.1_
- [ ] 15.2 Add performance tests
  - Create `src/__tests__/performance/Performance.test.ts`
  - Monitor frame rate during intensive gameplay
  - Test memory usage over extended sessions
  - _Requirements: 1.1, 2.1, 3.1, 4.1_
- [ ] 15.3 Implement visual regression tests
  - Create `src/__tests__/visual/VisualRegression.test.ts`
  - Capture screenshots of key game states
  - Test rendering consistency across browsers
  - _Requirements: 1.1, 2.1, 3.1, 4.1_
- [ ] 15.4 Create automated game mechanics tests
  - Test all tetromino rotations and placements
  - Verify collision detection and tube rotation
  - Validate scoring and game over conditions
  - _Requirements: 1.1, 2.1, 3.1, 4.1_